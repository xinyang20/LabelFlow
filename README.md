# LabelFlow - 快捷图片标注工具 V0.0.4-remake

简体中文 | [English](README_EN.md)

一款高效、易用的桌面应用程序，用于对图片进行文字描述和标签标注。

## 功能特点

- **多模式标注**：支持文字描述、标签选择和混合标注三种模式
- **智能图片管理**：使用SHA256哈希值确保图片与标签的准确对应
- **分片加载策略**：支持大量图片的高效处理，自动内存管理
- **灵活保存方式**：支持自动保存和手动保存模式，可自定义保存路径
- **数据备份保护**：内置图片base64编码，防止原图丢失
- **直观界面**：左右布局，图片显示与标注输入分离，支持图片缩放和拖拽
- **进度跟踪**：实时显示标注进度和文件信息
- **多语言支持**：支持中文和英文界面切换
- **标签管理**：智能标签缓存，支持标签复用和快速选择
- **版本管理**：动态版本号显示，便于版本追踪
- **快捷键系统**：全面的快捷键支持，提高标注效率
- **断点续标**：智能恢复标注进度，支持工作中断后继续
- **图像还原**：从JSON文件恢复缺失的图像文件
- **图像验证**：自动验证图像完整性并更新哈希值
- **一键重命名**：批量重命名图像文件，统一命名格式
- **文件目录显示**：支持双击跳转，实现间隔标注
- **危险操作保护**：重要操作前弹出确认提示



## 系统要求

- Windows/macOS/Linux
- Python 3.8+
- PyQt6
- Pillow

## 安装和运行

### 开发环境运行

1. 克隆项目到本地

2. 激活虚拟环境：

	```bash
	./.venv/Scripts/activate
	```

3. 安装依赖：

	```bash
	uv add PyQt6 Pillow
	```

4. 运行应用程序：

	```bash
	python src/main.py
	```

### 使用说明

1. **选择工作目录**：点击"文件"菜单中的"选择工作目录"，选择包含图片的文件夹
2. **设置保存路径**（可选）：点击"文件"菜单中的"设置标注保存路径"，自定义JSON文件保存位置
3. **配置标注模式**：在"设置"菜单中选择标注模式：
	- **描述模式**：纯文字描述标注
	- **标签模式**：标签选择标注，支持快捷键Ctrl+0-9快速选择
	- **混合模式**：同时支持文字描述和标签选择
4. **配置保存模式**：在"设置"菜单中可切换自动保存/手动保存模式
5. **兼容性设置**：在"设置"菜单中可开启兼容模式，支持V0.0.2版本数据格式
6. **语言设置**：在"设置"菜单中可切换中文/英文界面
7. **开始标注**：
	- 左侧显示当前图片，支持缩放、滚轮操作和Ctrl+鼠标拖拽
	- 右侧根据选择的模式显示相应的标注界面
	- 使用"上一张"/"下一张"按钮或Ctrl+左/右方向键切换图片
	- 底部文件目录显示框支持双击跳转到指定图片
8. **智能保存**：
	- 自动保存模式：切换图片时自动保存标注
	- 手动保存模式：切换图片前弹出保存确认对话框
	- 空内容智能跳过：没有标注内容时不会产生保存操作
9. **断点续标**：重新打开同一目录时，会自动加载之前的标注进度和可用标签，定位到第一张未标注的图片
10. **高级功能**：
	- **图像还原**：当图像文件缺失但存在JSON文件时，自动从base64编码还原图像
	- **图像验证**：自动验证图像完整性，发现变化时重新计算哈希值
	- **一键重命名**：批量重命名图像文件为IMG_XXXXXX格式（危险操作，需确认）

## 支持的图片格式

- JPG/JPEG
- PNG
- BMP
- TIFF/TIF

## 快捷键系统

V0.0.4版本提供完整的快捷键支持，提高标注效率：

### 全局快捷键
- **Ctrl+O**：打开工作目录
- **Ctrl+S**：设置保存路径
- **Ctrl+Q**：退出程序
- **Ctrl+A**：显示关于页面
- **Ctrl+Left**：上一张图片
- **Ctrl+Right**：下一张图片

### 标签模式快捷键
- **Ctrl+0-9**：快速选择对应序号的标签（仅在标签模式和混合模式下可用）
- 支持最多10个快捷标签，按照标签缓存顺序分配
- 第二次按下相同快捷键可取消选择

### 快捷键配置
- 快捷键设置保存在`keys_setting.json`文件中
- 支持自定义修改快捷键配置
- 程序启动时自动加载快捷键设置

## 数据格式

### 当前版本格式（V0.0.4）

每个图片对应一个独立的JSON标注文件，文件名与图片文件名相同（扩展名为.json）：

```json
{
  "filename": "IMG_001.jpg",
  "hash": "a1b2c3d4e5f6...",
  "describe": "图片的详细描述内容",
  "label": ["标签1", "标签2", "标签3"],
  "file_size": 2048576,
  "base64_data": "iVBORw0KGgoAAAANSUhEUgAA..."
}
```

**字段说明：**
- `filename`: 图片文件名
- `hash`: 图片的SHA256哈希值，用于唯一标识和完整性验证
- `describe`: 图片描述内容
- `label`: 标签数组
- `file_size`: 图片文件大小（字节）
- `base64_data`: 图片的base64编码，用于图像还原功能

### 兼容性支持

**V0.0.2格式兼容（需开启兼容模式）：**
```json
{
  "filename": "IMG_001.jpg",
  "hash": "a1b2c3d4e5f6...",
  "annotation": "图片描述内容",
  "file_size": 2048576,
  "base64_data": "iVBORw0KGgoAAAANSUhEUgAA..."
}
```

**注意：** V0.0.4版本默认关闭兼容模式，仅支持V0.0.3+数据格式。如需支持V0.0.2格式，请在"设置"菜单中开启兼容模式。V0.0.1版本格式已不再支持。

## 性能优化

- **分片加载**：图片数量少于100张时全部加载，否则分批加载
- **内存管理**：自动监控内存使用，避免超出1GB限制
- **后台计算**：哈希值和base64编码计算在后台线程进行，不影响UI响应
- **智能编码**：根据设备内存自动调整base64编码的文件大小限制
- **空内容优化**：智能跳过空标注内容的保存操作，减少无效文件生成

## 高级功能

### 多模式标注
- **描述模式**：专注于文字描述标注
- **标签模式**：快速标签选择和管理，支持Ctrl+0-9快捷键
- **混合模式**：同时支持描述和标签标注
- 可在运行时动态切换标注模式

### 智能标签管理
- 自动缓存历史标签，支持快速复用
- 从现有标注文件中提取标签
- 支持新标签的添加和管理
- 标签状态实时同步
- 标签模式和混合模式下显示快捷键提示

### 图片查看增强
- 支持图片缩放（10%-500%）
- 鼠标滚轮配合Ctrl键进行缩放
- Ctrl+鼠标拖拽移动图片
- 自适应显示和重置功能
- 滚动区域支持大图片浏览
- 可调整的分割面板布局

### 断点续标功能
- 自动检测并恢复之前的标注进度
- 智能定位到第一张未标注的图片
- 保持标注模式和可用标签列表
- 支持工作中断后无缝继续

### 图像管理功能
- **图像还原**：从JSON文件的base64编码自动还原缺失的图像文件
- **图像验证**：自动验证图像完整性，检测文件变化并更新哈希值
- **一键重命名**：批量重命名图像文件为IMG_XXXXXX格式，同步更新JSON文件
- **文件目录显示**：底部显示所有图像文件，支持双击跳转实现间隔标注

### 多语言界面
- 支持中文和英文界面
- 运行时动态语言切换
- 完整的界面本地化支持

### 自定义保存路径
- 支持设置标注文件的自定义保存路径
- 如未设置，默认保存在图片文件所在目录
- 设置后在切换工作目录前保持有效

### 自动保存模式
- **开启**：切换图片时自动保存当前标注
- **关闭**：切换图片前弹出保存确认对话框
- 默认开启，可在"设置"菜单中切换

### 数据备份保护
- 自动生成图片的base64编码并保存在JSON文件中
- 当原图片文件损坏或丢失时，可从标注文件恢复图像
- 根据设备性能自动调整编码文件大小限制（5MB-20MB）

### 安全保护机制
- 危险操作前弹出确认提示（一键重命名、不保存切换等）
- 二次确认机制防止误操作
- 数据完整性保护和验证

### 版本管理
- 状态栏显示当前版本号
- 版本信息从`src/app.info`文件读取
- 支持动态版本号管理

## 开发架构

项目采用MVC架构模式：

- `src/main.py`：程序入口
- `src/ui_mainwindow.py`：UI界面层，包含DraggableImageLabel类
- `src/app_controller.py`：控制器层，处理业务逻辑
- `src/data_manager.py`：数据模型层，管理图像和标注数据
- `src/shortcut_manager.py`：快捷键管理模块
- `src/language_manager.py`：多语言支持模块
- `src/about_dialog.py`：关于对话框
- `src/app.info`：应用配置文件
- `keys_setting.json`：快捷键配置文件

## 打包发布

使用PyInstaller打包为可执行文件：

```bash
pyinstaller --name LabelFlow --windowed --onefile src/main.py
```

## 许可证

本项目采用MIT许可证。
